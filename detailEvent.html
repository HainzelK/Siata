<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" href="css/styleDetail.css">
    <link rel="stylesheet" href="css/styleFooter.css">
    <link rel="stylesheet" href="css/styleNav.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <title>Detail Event</title>
    <link rel="icon" type="image/x-icon" href="css/siataLogo.svg">
    <style>
        .img-placeholder {
            width: 100%;
            height: 526px;
            background-color: #e9ecef;
        }
        .dropdown-menu {
            background-color: #e9ecef;
        }
        @media(min-width:280px) and (max-width:768px){
            footer{
                margin-top: 40%;
            }
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav>
        <a href="#">
            <img class="logo" src="css/siataLogo.svg" alt="Siata Logo">
        </a>
        <button onclick="openMenu()" class="menu-icon" aria-label="Menu">
            <svg fill="none" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M4 6H20M4 12H20M13 18H20" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" />
            </svg>
        </button>
        <ul class="nav">
            <li><a href="index.html" class="link">Home</a></li>
            <li><a href="kalender" class="link">Kalender</a></li>
            <li><a href="listEvent.html" class="link">Event</a></li>
            <li><a href="infoDestinasi.html" class="link">Destinasi</a></li>
            <li class="nav-item dropdown">
                <a href="#" id="profile-link" class="link dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">Profile</a>
                <ul class="dropdown-menu" aria-labelledby="profile-link">
                    <li><a class="dropdown-item" href="profile.html" id="lihat-detail-button">Lihat Detail</a></li>
                    <li><a class="dropdown-item" href="#" id="logout-button">Logout</a></li>
                </ul>
            </li>
            <li><a href="login.html" id="login-signup-btn" class="login-signup-btn">Login/Signup</a></li>
        </ul>
    </nav>
    <!-- End Navbar -->

    <div class="container">
        <div class="header">
            <div class="header-content">
                <img id="event-img" src="https://via.placeholder.com/1440x526" alt="Event Image" class="img-placeholder" />
            </div>
            <div class="header-overlay"></div>
            <div class="title placeholder-glow">
                <span id="event-title" class="placeholder col-6">Loading...</span>
            </div>
        </div>
        <div class="card-body location placeholder-glow">
            <span id="event-location" class="placeholder col-7">Loading lokasi...</span> <br>
            <span id="event-date" class="event-date">Tanggal: Loading...</span><br>
            <span id="event-time" class="event-time">Jam : Loading...</span><br>
            <span id="user-count" class="user-count">Loading...</span>
        </div>
        
        <div class="card-body description placeholder-glow">
            <span id="event-description" class="placeholder col-7">Tolong menunggu, loading data...</span>
        </div>
        <div class="button-container">
            <button id="volunteer-button" class="button-background">Ayo Ikut !</button>
        </div>
    </div>

    <!-- Footer -->
  <!--mulai footer-->
  <footer class="footer" >
    <div class="waves">
      <div class="wave" id="wave1"></div>
      <div class="wave" id="wave2"></div>
      <div class="wave" id="wave3"></div>
      <div class="wave" id="wave4"></div>
    </div>
  
    <ul class="menu">
      <li class="menu__item"><a class="menu__link" href="#"><img src="asset/xtwitter-icon.svg" width="22" height="auto"></a></li>
      <li class="menu__item"><a class="menu__link" href="#"><img src="asset/instagram-icon.svg" width="22" height="auto"></a></li>
      <li class="menu__item"><a class="menu__link" href="#"><img src="asset/facebook-icon.svg"width="22" height="auto"></a></li>
    </ul>

    <ul class="menu">
      <li class="menu__link">Siata</li>
    </ul>
  
  </footer>
  <!--selesai footer-->
    <!-- End Footer -->

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" crossorigin="anonymous"></script>
    <!-- skrip navbar -->
    <script src="scriptToken.js"></script>
    <script src="scriptNavbar.js"></script>
    <script>
// Function to fetch event details by event ID
async function fetchEventDetails(eventId) {
    try {
        const response = await fetch(`/api/event/id/${eventId}`);
        if (!response.ok) {
            throw new Error('Could not fetch event data');
        }
        const event = await response.json();
        if (event) {
            displayEventDetails(event.eventName, event.eventImg, event.eventDescription, event.location, event.eventDate, event.eventTime, event.eventId);
            fetchUserCount(event.eventId); // Fetch the user count after fetching event details
        } else {
            throw new Error('Event not found');
        }
    } catch (error) {
        console.error(error);
    }
}

// Function to fetch user count for an event
async function fetchUserCount(eventId) {
    try {
        const response = await fetch(`/api/volunteer/countuser/${eventId}`);
        if (!response.ok) {
            throw new Error('Could not fetch user count');
        }
        const userCount = await response.json();
        displayUserCount(userCount);
    } catch (error) {
        console.error(error);
    }
}

// Function to display user count
function displayUserCount(count) {
    const userCountElement = document.getElementById('user-count');
    userCountElement.innerText = `Jumlah Peserta: ${count}`;
    userCountElement.classList.remove('placeholder', 'placeholder-glow');
}

// Function to display event details
function displayEventDetails(eventName, eventImg, eventDescription, location, eventDate, eventTime, eventId) {
    const eventTitle = document.getElementById('event-title');
    const eventImgElement = document.getElementById('event-img');
    const eventDescriptionElement = document.getElementById('event-description');
    const eventLocationElement = document.getElementById('event-location');
    const eventDateElement = document.getElementById('event-date');
    const eventTimeElement = document.getElementById('event-time');
    const volunteerButton = document.getElementById('volunteer-button');

    eventTitle.innerText = eventName;
    eventImgElement.src = `data:image/jpeg;base64,${eventImg}`;
    eventDescriptionElement.innerText = eventDescription;
    eventLocationElement.innerText = `Lokasi: ${location}`;

    // Format date in Bahasa Indonesia
    const formattedDate = new Date(eventDate).toLocaleDateString('id-ID', {
        weekday: 'long', // "Minggu", "Senin", etc.
        year: 'numeric', // "2021"
        month: 'long', // "Januari", "Februari", etc.
        day: 'numeric' // "31"
    });
    eventDateElement.innerText = `Tanggal: ${formattedDate}`;

    eventTimeElement.innerText = `Waktu: ${eventTime}`;

    // Remove placeholder classes after setting the content
    eventTitle.classList.remove('placeholder', 'col-6', 'placeholder-glow');
    eventImgElement.classList.remove('img-placeholder');
    eventDescriptionElement.classList.remove('placeholder', 'col-7', 'placeholder-glow');
    eventLocationElement.classList.remove('placeholder', 'col-7', 'placeholder-glow');
    eventDateElement.classList.remove('placeholder', 'placeholder-glow');
    eventTimeElement.classList.remove('placeholder', 'placeholder-glow');

    // Disable volunteer button if the event date is in the past
    const currentDate = new Date();
    const eventDateObject = new Date(eventDate);
    if (eventDateObject < currentDate) {
        volunteerButton.disabled = true;
        volunteerButton.innerText = 'Event sudah lewat';
        volunteerButton.classList.add('disabled');
    } else {
        // Add event listener to volunteer button
        volunteerButton.addEventListener('click', function () {
            volunteerForEvent(eventId); // Pass the event ID
        });
    }
}
        // Function to volunteer for an event
        async function volunteerForEvent(eventId) {
            const token = getCookie('accessToken');
            if (!token) {
                alert('Please log in or sign up to volunteer for this event.');
                window.location.href = 'login.html'; // Redirect to login page
                return;
            }

            const email = extractEmailFromToken(token);
            if (!email) {
                throw new Error('Email not found in token');
            }

            const userId = await searchUserIdByEmail(email);
            try {
                if (!userId) {
                    alert('Please log in to volunteer for the event.');
                    return;
                }

                const response = await fetch('/api/volunteer', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ userId, eventId })
                });

                if (!response.ok) {
                    throw new Error('Could not volunteer for the event');
                }

                const result = await response.json();
                alert('You have successfully volunteered for the event!');
            } catch (error) {
                console.error(error);
                alert('An error occurred. Please try again.');
            }
        }

        // Add event listener to volunteer button
        document.getElementById('volunteer-button').addEventListener('click', function () {
            const urlParams = new URLSearchParams(window.location.search);
            const eventId = urlParams.get('id');
            if (eventId) {
                volunteerForEvent(eventId); // Pass the event ID
            }
        });

        // Placeholder function to get the logged-in user's ID
        function getUserId() {
            // Replace with actual logic to get the logged-in user's ID
            // For example, from session storage or a global variable
            return sessionStorage.getItem('userId');
        }
        // Call checkLoginStatus on page load
        document.addEventListener('DOMContentLoaded', checkLoginStatus);

        // Add event listener to logout button
        document.getElementById('logout-button').addEventListener('click', logout);

        // Load event details on page load
        document.addEventListener('DOMContentLoaded', function () {
            const urlParams = new URLSearchParams(window.location.search);
            const eventId = urlParams.get('id');
            if (eventId) {
                fetchEventDetails(eventId);
            }
        });

    </script>
</body>
</html>
